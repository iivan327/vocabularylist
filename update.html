<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Vocab Update (Auto Commit)</title>
</head>
<body>
<h2>Update Platform</h2>

<input id="word" placeholder="word / phrase"><br>
<input id="pos" placeholder="pos (v. / n. / phrase…)"><br>
<input id="forms" placeholder="forms | separated"><br>
<input id="synonyms" placeholder="synonyms | separated"><br>
<input id="antonyms" placeholder="antonyms | separated"><br>
<label><input type="checkbox" id="quiz"> Appears in quiz today</label><br><br>

<input id="token" placeholder="GitHub Token"><br>
<input id="owner" placeholder="GitHub Owner (username)"><br>
<input id="repo" placeholder="Repo name"><br><br>

<button onclick="commit()">Commit to GitHub</button>

<pre id="log"></pre>

<script>
const filePath = "vocab-db.json";

function today() {
  return new Date().toISOString().slice(0,10);
}

function split(v) {
  return v ? v.split("|").map(x=>x.trim()).filter(Boolean) : [];
}

async function commit() {
  const token = tokenInput.value;
  const owner = ownerInput.value;
  const repo = repoInput.value;

  const api = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

  const res = await fetch(api, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  const sha = data.sha;
  const db = JSON.parse(atob(data.content));

  const w = word.value.trim();
  if (!db[w]) {
    db[w] = {
      word: w,
      pos: pos.value,
      firstSeen: today(),
      quiz: { dates: [], count: 0 },
      relations: {
        forms: split(forms.value),
        synonyms: split(synonyms.value),
        antonyms: split(antonyms.value)
      }
    };
  }

  if (quiz.checked && !db[w].quiz.dates.includes(today())) {
    db[w].quiz.dates.push(today());
    db[w].quiz.count = db[w].quiz.dates.length;
  }

  const body = {
    message: `update vocab: ${w}`,
    content: btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2)))),
    sha
  };

  await fetch(api, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  log.textContent = "Committed successfully ✔";
}
</script>
</body>
</html>
